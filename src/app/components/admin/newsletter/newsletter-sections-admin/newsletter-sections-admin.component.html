<div class="max-w-4xl mx-auto p-6 space-y-8">

  <!-- Oversize warning modal -->
  <div *ngIf="showOversizeModal"
       class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded shadow-lg w-full max-w-sm p-6 space-y-4 text-center">
      <p class="text-lg">Files over 5 MB are not allowed. Please compress and retry.</p>
      <button class="bg-[#4EABBA] text-white px-4 py-2 rounded"
              (click)="showOversizeModal=false">OK</button>
    </div>
  </div>

  <header class="text-center">
    <h1 class="text-3xl font-bold">Manage “{{newsletterTitle}}” page</h1>
  </header>

  <!-- CTA Form -->
  <section class="bg-white p-4 rounded shadow space-y-4">
    <h2 class="text-xl font-semibold">Page CTA</h2>
    <form [formGroup]="ctaForm" (ngSubmit)="saveCta()"
          class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <input formControlName="title" placeholder="CTA Title"
               [ngClass]="{'border-red-500 shadow': ctaForm.get('title')!.invalid && ctaForm.get('title')!.touched}"
               class="border p-2 rounded w-full"/>
        <div *ngIf="ctaForm.get('title')!.invalid && ctaForm.get('title')!.touched"
             class="text-red-600 text-sm mt-1">Title is required</div>
      </div>
      <div>
        <input formControlName="buttonText" placeholder="Button Text"
               [ngClass]="{'border-red-500 shadow': ctaForm.get('buttonText')!.invalid && ctaForm.get('buttonText')!.touched}"
               class="border p-2 rounded w-full"/>
        <div *ngIf="ctaForm.get('buttonText')!.invalid && ctaForm.get('buttonText')!.touched"
             class="text-red-600 text-sm mt-1">Button Text is required</div>
      </div>
      <div class="md:col-span-2">
        <textarea formControlName="description" placeholder="CTA Description" rows="2"
                  [ngClass]="{'border-red-500 shadow': ctaForm.get('description')!.invalid && ctaForm.get('description')!.touched}"
                  class="border p-2 rounded w-full"></textarea>
        <div *ngIf="ctaForm.get('description')!.invalid && ctaForm.get('description')!.touched"
             class="text-red-600 text-sm mt-1">Description is required</div>
      </div>
      <div class="md:col-span-2">
        <input formControlName="buttonLink" placeholder="Button Link"
               [ngClass]="{'border-red-500 shadow': ctaForm.get('buttonLink')!.invalid && ctaForm.get('buttonLink')!.touched}"
               class="border p-2 rounded w-full"/>
        <div *ngIf="ctaForm.get('buttonLink')!.invalid && ctaForm.get('buttonLink')!.touched"
             class="text-red-600 text-sm mt-1">Button Link is required</div>
      </div>
      <button type="submit"
              class="bg-[#4EABBA] text-white px-4 py-2 rounded md:col-span-2"
              [disabled]="ctaForm.invalid || ctaSubmitting">
        {{ ctaSubmitting ? 'Saving…' : 'Save CTA' }}
      </button>
    </form>
  </section>

  <!-- Sections header -->
  <div class="flex justify-between items-center">
    <h2 class="text-2xl font-semibold">Sections for “{{newsletterTitle}}”</h2>
    <button (click)="openModal('create')"
            class="bg-[#4EABBA] text-white px-4 py-2 rounded">
      New Section
    </button>
  </div>

  <!-- Draggable list -->
  <div cdkDropList (cdkDropListDropped)="drop($event)" class="space-y-4">
    <div *ngFor="let sec of sections" cdkDrag
         class="bg-white p-4 rounded shadow flex justify-between items-center">
      <div>
        <span class="font-semibold">{{sec.type}}</span>
        <span class="ml-2 text-sm text-gray-500">Order: {{sec.order}}</span>
        <div class="text-sm mt-1">
          {{ sec.type==='banner' ? $any(sec.data).headline : $any(sec.data).title }}
          <span *ngIf="!sec.isActive"
                class="ml-2 px-1 text-xs bg-red-200 text-red-800 rounded">Inactive</span>
        </div>
      </div>
      <div class="flex gap-2">
        <button (click)="openModal('edit', sec)" title="Edit">✏️</button>
        <button (click)="confirmDelete(sec)" title="Delete">🗑️</button>
      </div>
    </div>
  </div>

  <!-- Create/Edit Modal -->
  <div *ngIf="showModal"
       class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center pt-2 z-50">
    <div class="bg-white rounded shadow-lg w-full max-w-2xl overflow-auto max-h-[80vh]">
      <header class="flex justify-between items-center p-4 border-b">
        <h3 class="text-xl font-semibold">
          {{ modalMode==='create' ? 'New Section' : 'Edit Section' }}
        </h3>
        <button (click)="closeModal()">✖️</button>
      </header>
      <div class="p-4">
        <form [formGroup]="modalForm" (ngSubmit)="saveSection()">

          <!-- Type / Order / Active -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <label class="flex flex-col">
              <span class="font-semibold mb-1">Type</span>
              <select formControlName="type" class="border p-2 rounded">
                <option value="banner">banner</option>
                <option value="content">content</option>
              </select>
            </label>
            <label class="flex flex-col">
              <span class="font-semibold mb-1">Order</span>
              <input type="number" formControlName="order"
                     [ngClass]="{'border-red-500 shadow': modalForm.get('order')!.invalid && modalForm.get('order')!.touched}"
                     class="border p-2 rounded"/>
              <div *ngIf="modalForm.get('order')!.invalid && modalForm.get('order')!.touched"
                   class="text-red-600 text-sm mt-1">Order is required</div>
            </label>
            <label class="flex items-center space-x-2">
              <input type="checkbox" formControlName="isActive"/>
              <span class="font-semibold">Active</span>
            </label>
          </div>

          <!-- Banner fields -->
          <div *ngIf="modalForm.value.type==='banner'" class="space-y-4 mb-4">
            <div>
              <label class="block font-semibold mb-1">Eyebrow</label>
              <input formControlName="eyebrow"
                     [ngClass]="{'border-red-500 shadow': modalForm.get('eyebrow')!.invalid && modalForm.get('eyebrow')!.touched}"
                     class="border p-2 rounded w-full"/>
              <div *ngIf="modalForm.get('eyebrow')!.invalid && modalForm.get('eyebrow')!.touched"
                   class="text-red-600 text-sm mt-1">Eyebrow is required</div>
            </div>
            <div>
              <label class="block font-semibold mb-1">Headline</label>
              <input formControlName="headline"
                     [ngClass]="{'border-red-500 shadow': modalForm.get('headline')!.invalid && modalForm.get('headline')!.touched}"
                     class="border p-2 rounded w-full"/>
              <div *ngIf="modalForm.get('headline')!.invalid && modalForm.get('headline')!.touched"
                   class="text-red-600 text-sm mt-1">Headline is required</div>
            </div>
            <div>
              <label class="block font-semibold mb-1">Subtitle (optional)</label>
              <input formControlName="subtitle" class="border p-2 rounded w-full"/>
            </div>
          </div>

          <!-- Content fields -->
          <div *ngIf="modalForm.value.type==='content'" class="space-y-4 mb-4">
            <div>
              <label class="block font-semibold mb-1">Title</label>
              <input formControlName="title"
                     [ngClass]="{'border-red-500 shadow': modalForm.get('title')!.invalid && modalForm.get('title')!.touched}"
                     class="border p-2 rounded w-full"/>
              <div *ngIf="modalForm.get('title')!.invalid && modalForm.get('title')!.touched"
                   class="text-red-600 text-sm mt-1">Title is required</div>
            </div>

            <div *ngIf="modalForm.value.divider" class="grid grid-cols-2 gap-4">
              <div>
                <label class="block font-semibold mb-1">Column 1 Description</label>
                <textarea formControlName="description" rows="3"
                          [ngClass]="{'border-red-500 shadow': modalForm.get('description')!.invalid && modalForm.get('description')!.touched}"
                          class="border p-2 rounded w-full"></textarea>
                <div *ngIf="modalForm.get('description')!.invalid && modalForm.get('description')!.touched"
                     class="text-red-600 text-sm mt-1">Column 1 description is required</div>
              </div>
              <div>
                <label class="block font-semibold mb-1">Column 2 Description</label>
                <textarea formControlName="column2Description" rows="3"
                          [ngClass]="{'border-red-500 shadow': modalForm.get('column2Description')!.invalid && modalForm.get('column2Description')!.touched}"
                          class="border p-2 rounded w-full"></textarea>
                <div *ngIf="modalForm.get('column2Description')!.invalid && modalForm.get('column2Description')!.touched"
                     class="text-red-600 text-sm mt-1">Column 2 description is required</div>
              </div>
            </div>

            <div *ngIf="!modalForm.value.divider">
              <label class="block font-semibold mb-1">Description</label>
              <textarea formControlName="description" rows="3"
                        [ngClass]="{'border-red-500 shadow': modalForm.get('description')!.invalid && modalForm.get('description')!.touched}"
                        class="border p-2 rounded w-full"></textarea>
              <div *ngIf="modalForm.get('description')!.invalid && modalForm.get('description')!.touched"
                   class="text-red-600 text-sm mt-1">Description is required</div>
            </div>

            <div class="grid grid-cols-2 gap-4 items-center">
              <label class="flex items-center space-x-2">
                <input type="checkbox" formControlName="divider"/>
                <span>Show Divider</span>
              </label>
              <label class="flex items-center space-x-2">
                <span class="font-semibold">Image Position</span>
                <select formControlName="imagePosition" class="border p-2 rounded">
                  <option value="none">none</option>
                  <option value="left">left</option>
                  <option value="right">right</option>
                </select>
              </label>
            </div>

            <div>
              <label class="block font-semibold mb-1">Intro (golden)</label>
              <input formControlName="intro" class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label class="block font-semibold mb-1">Outro (golden)</label>
              <input formControlName="outro" class="border p-2 rounded w-full"/>
            </div>
          </div>

          <!-- File upload & preview -->
          <div class="space-y-2 mb-4">
            <label class="block font-semibold">Upload Image/Video</label>
            <input type="file"
                   (change)="onMediaSelected($event)"
                   accept="image/*,video/*"
                   class="block mb-2"/>
            <div *ngIf="mediaPreviewUrl" class="relative">
              <img *ngIf="mediaPreviewUrl.startsWith('data:image')"
                   [src]="mediaPreviewUrl"
                   class="max-h-40 rounded shadow"/>
              <video *ngIf="mediaPreviewUrl.startsWith('data:video')"
                     [src]="mediaPreviewUrl"
                     controls
                     class="max-h-40 rounded shadow"></video>
              <button type="button"
                      class="absolute top-1 right-1 text-white rounded-full w-6 h-6 flex items-center justify-center"
                      (click)="removeMedia()">✖️</button>
            </div>
          </div>

        </form>
      </div>

      <footer class="flex justify-end gap-2 p-4 border-t">
        <button class="bg-red-200 text-white px-4 py-2 rounded" (click)="closeModal()">Cancel</button>
        <button class="bg-[#4EABBA] text-white px-4 py-2 rounded"
                (click)="saveSection()">
          {{ submitting ? 'Saving…' : (modalMode==='create'?'Create':'Save') }}
        </button>
      </footer>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div *ngIf="showDeleteModal"
       class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded shadow-lg w-full max-w-md p-6 space-y-4">
      <h2 class="text-xl font-semibold">Confirm Deletion</h2>
      <p>Are you sure you want to delete this section?</p>
      <div class="flex justify-end gap-2 mt-4">
        <button (click)="cancelDelete()" class="px-4 py-2 border rounded" [disabled]="deleting">Cancel</button>
        <button (click)="deleteSection()"
                class="bg-red-200 text-white px-4 py-2 rounded"
                [disabled]="deleting">
          {{ deleting ? 'Deleting…' : 'Delete' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Result Modal -->
  <div *ngIf="showResult"
       class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded shadow-lg w-full max-w-sm p-6 space-y-4 text-center">
      <p class="text-lg">{{ resultMsg }}</p>
      <button class="bg-[#4EABBA] text-white px-4 py-2 rounded" (click)="closeResult()">OK</button>
    </div>
  </div>

</div>
