<div class="max-w-5xl mx-auto p-6 space-y-12">

  <!-- Title -->
  <header class="text-center">
    <h1 class="text-3xl font-bold">Manage Case Studies</h1>
  </header>

  <!-- Banner Section -->
  <section class="space-y-4">
    <h2 class="text-2xl font-semibold">Banner Section</h2>
    <form [formGroup]="bannerForm" (ngSubmit)="saveBanner()"
          class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <input formControlName="eyebrow" placeholder="Small Heading"
             class="border p-2 rounded"/>
      <input formControlName="headline" placeholder="Main Heading"
             class="border p-2 rounded col-span-1 md:col-span-2"/>
      <input formControlName="subtitle" placeholder="Subheading (optional)"
             class="border p-2 rounded col-span-1 md:col-span-2"/>

      <!-- File chooser & preview -->
      <div class="flex gap-4 items-center col-span-1 md:col-span-2">
        <label class="font-semibold block">Background Image</label>
        <input type="file" (change)="onBannerFileSelected($event)"
               accept="image/*" [disabled]="bannerSubmitting"/>
        <img *ngIf="bannerForm.value.imageUrl"
             [src]="bannerForm.value.imageUrl"
             class="h-12 w-12 object-cover rounded"/>
        <button *ngIf="bannerForm.value.imageUrl"
                type="button"
                class="text-red-600"
                (click)="removeBannerImage()"
                [disabled]="bannerSubmitting"
        >✖️</button>
      </div>

      <button type="submit"
              class="bg-[#4EABBA] text-white px-4 py-2 rounded col-span-1 md:col-span-2 disabled:opacity-50"
              [disabled]="bannerForm.invalid || bannerSubmitting">
        {{ bannerSubmitting ? 'Submitting...' : 'Save Banner' }}
      </button>
    </form>
  </section>

  <!-- Case Studies Table -->
  <section class="space-y-4">
    <div class="flex justify-between items-center">
      <h2 class="text-2xl font-semibold">Case Studies</h2>
      <button (click)="openModal('create')"
              class="bg-[#4EABBA] text-white px-4 py-2 rounded disabled:opacity-50">
        Add Case Study
      </button>
    </div>

    <div *ngIf="studies.length === 0"
         class="text-center py-16 text-gray-500">
      No case studies found.
    </div>

    <div *ngIf="studies.length"
         class="bg-white shadow rounded p-4 overflow-x-auto">
      <table class="min-w-full table-auto">
        <thead>
          <tr class="bg-gray-100">
            <th class="p-2 text-left">Order</th>
            <th class="p-2 text-left">Title</th>
            <th class="p-2 text-left">Description</th>
            <th class="p-2 text-center">Active</th>
            <th class="p-2 text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let s of studies" class="border-t">
            <td class="p-2">{{ s.order }}</td>
            <td class="p-2">{{ s.title }}</td>
            <td class="p-2">{{ s.description }}</td>
            <td class="p-2 text-center">
              <span [ngClass]="
                        s.isActive
                          ? 'bg-green-200 text-green-800'
                          : 'bg-red-200 text-red-800'"
                    class="px-2 py-1 rounded">
                {{ s.isActive ? 'Active' : 'Inactive' }}
              </span>
            </td>
            <td class="p-2 text-center space-x-2">
              <button title="Sections" (click)="onSections(s)" class="px-2">📁</button>
              <button title="View" (click)="openModal('view', s)" class="px-2">👁️</button>
              <button title="Edit" (click)="openModal('edit', s)" class="px-2">✏️</button>
              <button title="Delete" (click)="confirmDelete(s)" class="px-2">🗑️</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <nav *ngIf="totalPages > 1" class="flex justify-center mt-4">
      <ul class="inline-flex -space-x-px">
        <li *ngFor="let p of pages">
          <button (click)="loadPage(p)"
                  [ngClass]="
                    p === currentPage
                      ? 'bg-[#4EABBA] text-white'
                      : 'bg-white text-gray-700 hover:bg-gray-100'"
                  class="px-3 py-1 border border-gray-300">
            {{ p }}
          </button>
        </li>
      </ul>
    </nav>
  </section>

  <!-- CTA Section -->
  <section class="space-y-4">
    <h2 class="text-2xl font-semibold">CTA Section</h2>
    <form [formGroup]="ctaForm"
          (ngSubmit)="saveCta()"
          class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <input formControlName="title"       placeholder="CTA Title" class="border p-2 rounded"/>
      <textarea formControlName="description"
                placeholder="CTA Description"
                rows="2"
                class="border p-2 rounded"></textarea>
      <input formControlName="buttonText"   placeholder="Button Text"  class="border p-2 rounded"/>
      <input formControlName="buttonRoute"  placeholder="Button Route" class="border p-2 rounded"/>

      <button type="submit"
              class="bg-[#4EABBA] text-white px-4 py-2 rounded col-span-1 md:col-span-2 disabled:opacity-50"
              [disabled]="ctaForm.invalid || ctaSubmitting">
        {{ ctaSubmitting ? 'Submitting...' : 'Save CTA' }}
      </button>
    </form>
  </section>
</div>

<!-- Image‑size Error Modal -->
<div *ngIf="showImageError"
     class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded shadow-lg w-full max-w-md p-6 space-y-4 text-center">
    <p class="text-lg">{{ imageErrorMessage }}</p>
    <button class="bg-[#4EABBA] text-white px-4 py-2 rounded"
            (click)="closeImageError()">
      OK
    </button>
  </div>
</div>

<!-- Create/Edit/View Modal -->
<div *ngIf="showModal"
     class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded shadow-lg w-full max-w-2xl p-6 space-y-4">
    <header class="flex justify-between items-center">
      <h3 class="text-xl font-semibold">
        {{ modalMode === 'create'
            ? 'New Case Study'
            : modalMode === 'edit'
              ? 'Edit Case Study'
              : 'View Case Study' }}
      </h3>
      <button (click)="closeModal()" class="text-gray-500 hover:text-gray-800">✖️</button>
    </header>

    <form [formGroup]="modalForm" (ngSubmit)="saveStudy()" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input formControlName="order" type="number" placeholder="Order"
               class="border p-2 rounded" [readonly]="modalMode==='view'"/>
        <input formControlName="title" placeholder="Title"
               class="border p-2 rounded" [readonly]="modalMode==='view'"/>
      </div>

      <div>
        <textarea formControlName="description" rows="2" placeholder="Description"
                  class="border p-2 rounded w-full" [readonly]="modalMode==='view'"></textarea>
      </div>

      <div formArrayName="stats" class="space-y-2">
        <div *ngFor="let ctrl of stats.controls; let i = index" [formGroupName]="i"
             class="grid grid-cols-2 gap-2">
          <input formControlName="value" placeholder="Stat Value"
                 class="border p-2 rounded" [readonly]="modalMode==='view'"/>
          <input formControlName="label" placeholder="Stat Label"
                 class="border p-2 rounded" [readonly]="modalMode==='view'"/>
        </div>
      </div>

      <div class="flex items-center space-x-2">
        <input type="checkbox" formControlName="isActive" id="active"
               [disabled]="modalMode==='view'"/>
        <label for="active">Active</label>
      </div>

      <div class="flex justify-end space-x-2">
        <button type="button" (click)="closeModal()"
                class="px-4 py-2 border rounded" [disabled]="modalSubmitting">
          Close
        </button>
        <button *ngIf="modalMode!=='view'" type="submit"
                class="bg-[#4EABBA] text-white px-4 py-2 rounded disabled:opacity-50"
                [disabled]="modalForm.invalid || modalSubmitting">
          {{ modalMode==='create'
               ? (modalSubmitting ? 'Submitting...' : 'Create')
               : (modalSubmitting ? 'Submitting...' : 'Save') }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div *ngIf="showDeleteModal"
     class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded shadow-lg w-full max-w-md p-6 space-y-4">
    <h2 class="text-xl font-semibold">Confirm Deletion</h2>
    <p>Are you sure you want to delete<br/>
      <strong>{{ deleteTarget?.title }}</strong>?</p>
    <div class="flex justify-end gap-2 pt-4">
      <button (click)="cancelDelete()" class="px-4 py-2 border rounded" [disabled]="deleteSubmitting">
        Cancel
      </button>
      <button (click)="deleteStudy()"
              class="bg-red-600 text-white px-4 py-2 rounded disabled:opacity-50"
              [disabled]="deleteSubmitting">
        {{ deleteSubmitting ? 'Submitting...' : 'Delete' }}
      </button>
    </div>
  </div>
</div>

<!-- Operation Result Modal -->
<div *ngIf="showResultModal"
     class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded shadow-lg w-full max-w-sm p-6 space-y-4 text-center">
    <p class="text-lg">{{ resultMessage }}</p>
    <button class="bg-[#4EABBA] text-white px-4 py-2 rounded"
            (click)="closeResultModal()">
      OK
    </button>
  </div>
</div>
